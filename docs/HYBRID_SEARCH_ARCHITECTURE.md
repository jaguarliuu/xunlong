# æ··åˆæœç´¢æ¶æ„ - MCP + æµè§ˆå™¨

## è®¾è®¡ç†å¿µ

XunLong é‡‡ç”¨**ä¸¤é˜¶æ®µæ··åˆæœç´¢æ¶æ„**ï¼Œå……åˆ†å‘æŒ¥ MCP æœåŠ¡å’Œæµè§ˆå™¨è‡ªåŠ¨åŒ–çš„å„è‡ªä¼˜åŠ¿ï¼š

### ğŸ¯ æ ¸å¿ƒé—®é¢˜

ä¼ ç»Ÿæœç´¢æ–¹æ¡ˆçš„ç—›ç‚¹ï¼š

1. **çº¯æµè§ˆå™¨æ–¹æ¡ˆ (DuckDuckGo + Playwright)**
   - âŒ ç»å¸¸é‡åˆ°éªŒè¯ç 
   - âŒ å¯åŠ¨æµè§ˆå™¨æ…¢
   - âŒ ç½‘ç»œæ³¢åŠ¨å½±å“å¤§
   - âŒ æœç´¢ç»“æœè¢«å¹¿å‘Šæ±¡æŸ“

2. **çº¯ MCP æ–¹æ¡ˆ**
   - âŒ åªèƒ½è·å–æ‘˜è¦ï¼Œæ— æ³•è·å–å®Œæ•´å†…å®¹
   - âŒ æ— æ³•æå–å›¾ç‰‡
   - âŒ å†…å®¹æ·±åº¦ä¸å¤Ÿ

### âœ… æ··åˆè§£å†³æ–¹æ¡ˆ

å°†æœç´¢è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œå„å¸å…¶èŒï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ··åˆæœç´¢æ¶æ„                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é˜¶æ®µä¸€: æœç´¢é˜¶æ®µï¼ˆè·å–URLåˆ—è¡¨ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP æœç´¢ (ä¼˜å…ˆ) æˆ– DuckDuckGo (é™çº§)        â”‚
â”‚                                             â”‚
â”‚  âœ“ å¿«é€Ÿè·å–æœç´¢ç»“æœ                          â”‚
â”‚  âœ“ æ— éªŒè¯ç å›°æ‰°                              â”‚
â”‚  âœ“ è·å¾—: æ ‡é¢˜ã€æ‘˜è¦ã€URL                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
é˜¶æ®µäºŒ: å†…å®¹æŠ“å–é˜¶æ®µï¼ˆè®¿é—®URLè·å–å®Œæ•´ä¿¡æ¯ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Playwright æµè§ˆå™¨è‡ªåŠ¨åŒ–                     â”‚
â”‚                                             â”‚
â”‚  âœ“ è®¿é—®æ¯ä¸ªURL                              â”‚
â”‚  âœ“ æå–å®Œæ•´æ­£æ–‡å†…å®¹                          â”‚
â”‚  âœ“ æå–æ–‡ç« ä¸­çš„å›¾ç‰‡                          â”‚
â”‚  âœ“ è·å¾—: full_content + images              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ€ç»ˆç»“æœ: åŒ…å«å®Œæ•´å†…å®¹å’Œå›¾ç‰‡çš„æœç´¢ç»“æœ       â”‚
â”‚                                             â”‚
â”‚  â€¢ title (æ ‡é¢˜)                             â”‚
â”‚  â€¢ url (é“¾æ¥)                               â”‚
â”‚  â€¢ snippet (æ‘˜è¦ - æ¥è‡ªMCP)                 â”‚
â”‚  â€¢ full_content (å®Œæ•´å†…å®¹ - æ¥è‡ªæµè§ˆå™¨)      â”‚
â”‚  â€¢ images[] (å›¾ç‰‡åˆ—è¡¨ - æ¥è‡ªæµè§ˆå™¨)          â”‚
â”‚  â€¢ source (æ¥æºæ ‡è¯†)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€æœ¯å®ç°

### 1. WebSearcher ç±»è®¾è®¡

```python
class WebSearcher:
    def __init__(
        self,
        prefer_mcp: bool = True,      # ä¼˜å…ˆä½¿ç”¨MCP
        extract_content: bool = True,  # æ˜¯å¦æŠ“å–å®Œæ•´å†…å®¹
        extract_images: bool = True    # æ˜¯å¦æå–å›¾ç‰‡
    ):
        self.mcp_manager = get_mcp_manager()
        self.duckduckgo_searcher = DuckDuckGoSearcher()
        # ...

    async def search(self, query: str, max_results: int = 10):
        """
        ä¸¤é˜¶æ®µæœç´¢æµç¨‹
        """
        # é˜¶æ®µä¸€: è·å–æœç´¢ç»“æœï¼ˆURLåˆ—è¡¨ï¼‰
        results = await self._get_search_results(query, max_results)

        # é˜¶æ®µäºŒ: æŠ“å–å®Œæ•´å†…å®¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if self.extract_content:
            results = await self._fetch_full_content_with_browser(results)

        return results
```

### 2. é˜¶æ®µä¸€ï¼šæœç´¢é˜¶æ®µ

**ä¼˜å…ˆçº§ç­–ç•¥**:
1. å¦‚æœé…ç½®äº† MCP (å¦‚æ™ºè°± Web æœç´¢)ï¼Œä¼˜å…ˆä½¿ç”¨ MCP
2. å¦‚æœ MCP å¤±è´¥æˆ–æœªé…ç½®ï¼Œè‡ªåŠ¨é™çº§åˆ° DuckDuckGo
3. å¼ºåˆ¶ä½¿ç”¨ DuckDuckGo: è®¾ç½® `force_duckduckgo=True`

**è¾“å‡ºç»“æœ**:
```python
{
    "title": "æ–‡ç« æ ‡é¢˜",
    "url": "https://example.com/article",
    "snippet": "æ–‡ç« æ‘˜è¦...",
    "source": "zhipu_web_search"  # æˆ– "duckduckgo"
}
```

### 3. é˜¶æ®µäºŒï¼šå†…å®¹æŠ“å–é˜¶æ®µ

ä½¿ç”¨ Playwright æ— å¤´æµè§ˆå™¨è®¿é—®æ¯ä¸ª URLï¼š

#### å†…å®¹æå–ç­–ç•¥

```python
# ä¼˜å…ˆçº§é€‰æ‹©å™¨åˆ—è¡¨
content_selectors = [
    "article",           # HTML5 è¯­ä¹‰åŒ–æ ‡ç­¾
    "main",              # ä¸»è¦å†…å®¹åŒº
    "[role='main']",     # ARIA æ ‡è¯†
    ".content",          # å¸¸è§ç±»å
    ".article-content",
    ".post-content",
    "#content",
    ".main-content"
]
```

#### å›¾ç‰‡æå–ç­–ç•¥

```python
# è¿‡æ»¤æ¡ä»¶
- æœ€å°å°ºå¯¸: 200x200 åƒç´ ï¼ˆè¿‡æ»¤å°å›¾æ ‡ï¼‰
- æœ€å¤§æ•°é‡: æ¯ç¯‡æ–‡ç« æœ€å¤š10å¼ å›¾ç‰‡
- è·³è¿‡ data: URLï¼ˆbase64å›¾ç‰‡ï¼‰
- å¤„ç†ç›¸å¯¹è·¯å¾„ï¼Œè½¬æ¢ä¸ºç»å¯¹URL
```

**è¾“å‡ºç»“æœ**:
```python
{
    "title": "æ–‡ç« æ ‡é¢˜",
    "url": "https://example.com/article",
    "snippet": "æ–‡ç« æ‘˜è¦...",
    "source": "zhipu_web_search",

    # æ–°å¢å­—æ®µ
    "full_content": "å®Œæ•´æ­£æ–‡å†…å®¹...",
    "has_full_content": True,
    "images": [
        {
            "url": "https://example.com/img1.jpg",
            "alt": "å›¾ç‰‡æè¿°",
            "width": 800,
            "height": 600
        },
        # ...
    ],
    "image_count": 5
}
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: ç ”ç©¶æŠ¥å‘Šç”Ÿæˆ

```python
searcher = WebSearcher(
    prefer_mcp=True,
    extract_content=True,   # éœ€è¦å®Œæ•´å†…å®¹
    extract_images=True     # éœ€è¦é…å›¾
)

results = await searcher.search("AIæœ€æ–°è¿›å±•", max_results=5)

# ç»“æœå¯ä»¥ç›´æ¥ç”¨äºç”Ÿæˆå¸¦å›¾ç‰‡çš„ç ”ç©¶æŠ¥å‘Š
for result in results:
    # ç”ŸæˆæŠ¥å‘Šç« èŠ‚
    report_section = f"""
    ## {result['title']}

    {result['full_content']}

    {"![å›¾ç‰‡](" + result['images'][0]['url'] + ")" if result['images'] else ""}
    """
```

### åœºæ™¯ 2: å¿«é€Ÿæœç´¢ï¼ˆä»…éœ€æ‘˜è¦ï¼‰

```python
searcher = WebSearcher(
    prefer_mcp=True,
    extract_content=False,  # ä¸éœ€è¦å®Œæ•´å†…å®¹
    extract_images=False
)

results = await searcher.search("Pythonæ•™ç¨‹", max_results=10)
# å¿«é€Ÿè¿”å›ï¼Œåªæœ‰æ ‡é¢˜å’Œæ‘˜è¦
```

### åœºæ™¯ 3: ä¸¤æ­¥å¼æœç´¢

```python
# ç¬¬ä¸€æ­¥ï¼šå¿«é€Ÿæœç´¢å¤§é‡å€™é€‰
quick_searcher = WebSearcher(extract_content=False)
candidates = await quick_searcher.search("æœºå™¨å­¦ä¹ ", max_results=20)

# ç¬¬äºŒæ­¥ï¼šç”¨æˆ·é€‰æ‹©åå†æŠ“å–å®Œæ•´å†…å®¹
selected_urls = [candidates[0], candidates[3], candidates[5]]

full_searcher = WebSearcher(extract_content=True, extract_images=True)
detailed = await full_searcher._fetch_full_content_with_browser(selected_urls)
```

## æ€§èƒ½ä¼˜åŒ–

### 1. æœç´¢é˜¶æ®µä¼˜åŒ–

- **MCPä¼˜å…ˆ**: APIè°ƒç”¨ï¼Œå»¶è¿Ÿ < 2ç§’
- **æ— éœ€æµè§ˆå™¨**: èŠ‚çœèµ„æºå’Œæ—¶é—´
- **å¹¶å‘æœç´¢**: æ”¯æŒå¤šæºMCPåŒæ—¶æœç´¢

### 2. æŠ“å–é˜¶æ®µä¼˜åŒ–

```python
# ä½¿ç”¨æ— å¤´æ¨¡å¼
browser = await p.chromium.launch(headless=True)

# è®¾ç½®åˆç†è¶…æ—¶
page.set_default_timeout(30000)  # 30ç§’

# ç­‰å¾…ç­–ç•¥
await page.goto(url, wait_until="domcontentloaded")  # ä¸ç­‰å¾…æ‰€æœ‰èµ„æº
```

### 3. é”™è¯¯å¤„ç†

- **ä¼˜é›…é™çº§**: MCPå¤±è´¥ â†’ DuckDuckGo
- **å®¹é”™æœºåˆ¶**: å•ä¸ªURLæŠ“å–å¤±è´¥ä¸å½±å“å…¶ä»–ç»“æœ
- **ä¿ç•™åŸå§‹æ•°æ®**: å³ä½¿æŠ“å–å¤±è´¥ï¼Œä»ä¿ç•™æ‘˜è¦ä¿¡æ¯

## é…ç½®é€‰é¡¹

### åˆå§‹åŒ–å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `prefer_mcp` | bool | True | æ˜¯å¦ä¼˜å…ˆä½¿ç”¨MCPæœç´¢ |
| `extract_content` | bool | True | æ˜¯å¦æŠ“å–å®Œæ•´å†…å®¹ |
| `extract_images` | bool | True | æ˜¯å¦æå–å›¾ç‰‡ |

### æœç´¢å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `query` | str | - | æœç´¢æŸ¥è¯¢ |
| `max_results` | int | 10 | æœ€å¤§ç»“æœæ•° |
| `force_duckduckgo` | bool | False | å¼ºåˆ¶ä½¿ç”¨DuckDuckGo |
| `fetch_full_content` | bool | None | è¦†ç›–åˆå§‹åŒ–é…ç½® |

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **é…ç½® MCP API Key** - é¿å…éªŒè¯ç ï¼Œæå‡é€Ÿåº¦
2. **æ ¹æ®éœ€æ±‚é€‰æ‹©æ¨¡å¼** - ä¸æ€»æ˜¯éœ€è¦å®Œæ•´å†…å®¹
3. **åˆç†è®¾ç½® max_results** - å†…å®¹æŠ“å–è€—æ—¶ï¼Œä¸è¦è¿‡å¤š
4. **å¼‚æ­¥è°ƒç”¨** - å……åˆ†åˆ©ç”¨å¼‚æ­¥ç‰¹æ€§

### âŒ é¿å…åšæ³•

1. **ä¸é…ç½® MCP å°±å¤§é‡æœç´¢** - å®¹æ˜“è§¦å‘éªŒè¯ç 
2. **æ€»æ˜¯æŠ“å–å®Œæ•´å†…å®¹** - å¦‚æœåªéœ€è¦URLåˆ—è¡¨ï¼Œå…³é—­æŠ“å–
3. **åŒæ­¥è°ƒç”¨** - ä¼šé˜»å¡äº‹ä»¶å¾ªç¯
4. **å¿½ç•¥é”™è¯¯** - æ£€æŸ¥ `has_full_content` å’Œ `fetch_error`

## æ‰©å±•æ€§

### æ·»åŠ æ–°çš„å†…å®¹æå–å™¨

```python
# å¯ä»¥ä¸ºç‰¹å®šç½‘ç«™å®šåˆ¶å†…å®¹æå–é€»è¾‘
def extract_from_medium(page):
    # Medium ç‰¹å®šçš„é€‰æ‹©å™¨
    return await page.query_selector("article").inner_text()

def extract_from_zhihu(page):
    # çŸ¥ä¹ç‰¹å®šçš„é€‰æ‹©å™¨
    return await page.query_selector(".Post-RichTextContainer").inner_text()
```

### æ”¯æŒæ›´å¤š MCP æœåŠ¡

åªéœ€åœ¨ `MCPManager` ä¸­æ³¨å†Œæ–°çš„ MCP å®¢æˆ·ç«¯ï¼š

```python
# æ·»åŠ æ–°çš„ MCP æœåŠ¡
class OtherMCPClient(BaseMCPClient):
    # å®ç°æ¥å£
    pass

# åœ¨ MCPManager ä¸­æ³¨å†Œ
manager.register_client("other_mcp", OtherMCPClient(api_key))
```

## æ€»ç»“

æ··åˆæœç´¢æ¶æ„é€šè¿‡ä¸¤é˜¶æ®µè®¾è®¡ï¼Œå®Œç¾ç»“åˆäº† MCP å’Œæµè§ˆå™¨è‡ªåŠ¨åŒ–çš„ä¼˜åŠ¿ï¼š

| ç‰¹æ€§ | MCP æœç´¢ | æµè§ˆå™¨æŠ“å– | æ··åˆæ–¹æ¡ˆ |
|------|----------|-----------|---------|
| é€Ÿåº¦ | â­â­â­â­â­ | â­â­ | â­â­â­â­ |
| å†…å®¹å®Œæ•´æ€§ | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| å›¾ç‰‡æ”¯æŒ | âŒ | âœ… | âœ… |
| éªŒè¯ç é£é™© | âœ… | âŒ | âœ… |
| èµ„æºæ¶ˆè€— | â­ | â­â­â­â­ | â­â­â­ |

**æœ€ç»ˆæ•ˆæœ**: â­â­â­â­â­ æ—¢å¿«åˆå…¨ï¼
