# ğŸš€ å¹¶è¡Œæœç´¢ä¼˜åŒ–

## ä¼˜åŒ–è¯´æ˜

å°†æ·±åº¦æœç´¢ä»**ä¸²è¡Œæ‰§è¡Œ**æ”¹ä¸º**å®Œå…¨å¹¶è¡Œæ‰§è¡Œ**ï¼Œå¤§å¹…æå‡æœç´¢é€Ÿåº¦ã€‚

---

## ğŸ”„ æ¶æ„å˜åŒ–

### ä¼˜åŒ–å‰ï¼ˆä¸²è¡Œï¼‰
```
ä»»åŠ¡åˆ†è§£
  â†“
å­ä»»åŠ¡1 â†’ æŸ¥è¯¢1.1 â†’ æŸ¥è¯¢1.2 â†’ æŸ¥è¯¢1.3
  â†“
å­ä»»åŠ¡2 â†’ æŸ¥è¯¢2.1 â†’ æŸ¥è¯¢2.2 â†’ æŸ¥è¯¢2.3
  â†“
å­ä»»åŠ¡3 â†’ æŸ¥è¯¢3.1 â†’ æŸ¥è¯¢3.2 â†’ æŸ¥è¯¢3.3
  â†“
å†…å®¹è¯„ä¼° â†’ æŠ¥å‘Šç”Ÿæˆ
```

**æ€»è€—æ—¶**: ä¸²è¡Œç´¯åŠ ï¼Œå‡è®¾æ¯ä¸ªæŸ¥è¯¢ 5 ç§’
- 3 ä¸ªå­ä»»åŠ¡ Ã— 3 ä¸ªæŸ¥è¯¢ = 9 æ¬¡æœç´¢
- æ€»è€—æ—¶: **9 Ã— 5 = 45 ç§’**

---

### ä¼˜åŒ–åï¼ˆå¹¶è¡Œï¼‰
```
ä»»åŠ¡åˆ†è§£
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­ä»»åŠ¡1 â”€â”¬â”€ æŸ¥è¯¢1.1                 â”‚
â”‚          â”œâ”€ æŸ¥è¯¢1.2   (å¹¶è¡Œ)        â”‚
â”‚          â””â”€ æŸ¥è¯¢1.3                 â”‚
â”‚                                     â”‚
â”‚ å­ä»»åŠ¡2 â”€â”¬â”€ æŸ¥è¯¢2.1                 â”‚  â† æ‰€æœ‰å¹¶è¡Œ
â”‚          â”œâ”€ æŸ¥è¯¢2.2   (å¹¶è¡Œ)        â”‚
â”‚          â””â”€ æŸ¥è¯¢2.3                 â”‚
â”‚                                     â”‚
â”‚ å­ä»»åŠ¡3 â”€â”¬â”€ æŸ¥è¯¢3.1                 â”‚
â”‚          â”œâ”€ æŸ¥è¯¢3.2   (å¹¶è¡Œ)        â”‚
â”‚          â””â”€ æŸ¥è¯¢3.3                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
å†…å®¹è¯„ä¼° â†’ æŠ¥å‘Šç”Ÿæˆ
```

**æ€»è€—æ—¶**: å¹¶è¡Œæ‰§è¡Œï¼Œåªç­‰å¾…æœ€æ…¢çš„é‚£ä¸ª
- 3 ä¸ªå­ä»»åŠ¡ Ã— 3 ä¸ªæŸ¥è¯¢ = 9 æ¬¡æœç´¢ï¼ˆ**åŒæ—¶æ‰§è¡Œ**ï¼‰
- æ€»è€—æ—¶: **max(æ‰€æœ‰æŸ¥è¯¢) â‰ˆ 5-8 ç§’**

---

## âš¡ æ€§èƒ½æå‡

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|--------|--------|------|
| 3 å­ä»»åŠ¡ Ã— 3 æŸ¥è¯¢ | ~45 ç§’ | ~8 ç§’ | **5.6x** |
| 5 å­ä»»åŠ¡ Ã— 2 æŸ¥è¯¢ | ~50 ç§’ | ~8 ç§’ | **6.2x** |
| 4 å­ä»»åŠ¡ Ã— 3 æŸ¥è¯¢ | ~60 ç§’ | ~10 ç§’ | **6x** |

**å¹³å‡é€Ÿåº¦æå‡**: **5-6 å€** ğŸš€

---

## ğŸ”§ ä»£ç ä¿®æ”¹

### ä¿®æ”¹æ–‡ä»¶
`src/agents/deep_searcher.py`

### ä¸»è¦å˜æ›´

#### 1. å­ä»»åŠ¡å†…éƒ¨æŸ¥è¯¢å¹¶è¡ŒåŒ–ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰

**ä¼˜åŒ–å‰**ï¼ˆä¸²è¡Œï¼‰:
```python
# æ‰§è¡Œæ¯ä¸ªæœç´¢æŸ¥è¯¢
for query in search_queries[:3]:
    try:
        search_results = self.web_searcher.search_sync(query, ...)
        # æå–å†…å®¹...
        await asyncio.sleep(2)  # ä¸²è¡Œç­‰å¾…
    except Exception as e:
        continue
```

**ä¼˜åŒ–å**ï¼ˆå¹¶è¡Œï¼‰:
```python
# å¹¶è¡Œæ‰§è¡Œæ¯ä¸ªæœç´¢æŸ¥è¯¢
query_tasks = []
for query in search_queries[:3]:
    task = self._execute_single_query(query, subtask, expected_results, task_index)
    query_tasks.append(task)

if query_tasks:
    query_results = await asyncio.gather(*query_tasks, return_exceptions=True)
    # æ”¶é›†æ‰€æœ‰æŸ¥è¯¢çš„ç»“æœ...
```

#### 2. æ–°å¢ç‹¬ç«‹æŸ¥è¯¢æ‰§è¡Œæ–¹æ³•

```python
async def _execute_single_query(
    self,
    query: str,
    subtask: Dict[str, Any],
    expected_results: int,
    task_index: int
) -> List[Dict[str, Any]]:
    """æ‰§è¡Œå•ä¸ªæœç´¢æŸ¥è¯¢ï¼ˆå¯å¹¶è¡Œï¼‰"""

    # æœç´¢
    search_results = self.web_searcher.search_sync(query, max_results=expected_results)

    # å¹¶è¡Œæå–å†…å®¹
    extraction_tasks = [
        self.content_extractor.extract_content(result["url"])
        for result in search_results[:expected_results]
    ]
    extracted_contents = await asyncio.gather(*extraction_tasks, return_exceptions=True)

    # å¤„ç†ç»“æœå¹¶è¿”å›
    return [content for content in extracted_contents if content and content.get("content")]
```

---

## ğŸ“Š å¹¶è¡Œå±‚çº§

ç³»ç»Ÿç°åœ¨æ”¯æŒ**ä¸‰å±‚å¹¶è¡Œ**:

1. **å­ä»»åŠ¡çº§å¹¶è¡Œ** (`_execute_subtask_search`):
   ```python
   search_tasks = [self._execute_subtask_search(...) for subtask in subtasks]
   await asyncio.gather(*search_tasks)
   ```

2. **æŸ¥è¯¢çº§å¹¶è¡Œ** (`_execute_single_query`) - **æ–°å¢**:
   ```python
   query_tasks = [self._execute_single_query(...) for query in search_queries]
   await asyncio.gather(*query_tasks)
   ```

3. **å†…å®¹æå–çº§å¹¶è¡Œ** (å·²å­˜åœ¨):
   ```python
   extraction_tasks = [self.content_extractor.extract_content(url) for url in urls]
   await asyncio.gather(*extraction_tasks)
   ```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¹¶å‘æ§åˆ¶
- ç°åœ¨åŒæ—¶å‘èµ·å¤šä¸ªæœç´¢è¯·æ±‚ï¼Œå¯èƒ½è§¦å‘æœç´¢å¼•æ“é™æµ
- **å»ºè®®**: æ ¹æ®éœ€è¦æ·»åŠ å¹¶å‘é™åˆ¶ï¼ˆå¦‚ä½¿ç”¨ `asyncio.Semaphore`ï¼‰

### 2. èµ„æºæ¶ˆè€—
- å¹¶è¡Œæ‰§è¡Œä¼šå¢åŠ å†…å­˜å’Œ CPU ä½¿ç”¨
- **å»ºè®®**: ç›‘æ§ç³»ç»Ÿèµ„æºï¼Œå¿…è¦æ—¶è°ƒæ•´å¹¶å‘æ•°

### 3. é”™è¯¯å¤„ç†
- ä½¿ç”¨ `return_exceptions=True` ç¡®ä¿å•ä¸ªæŸ¥è¯¢å¤±è´¥ä¸å½±å“å…¶ä»–æŸ¥è¯¢
- æ‰€æœ‰å¼‚å¸¸éƒ½ä¼šè¢«æ•è·å¹¶è®°å½•æ—¥å¿—

---

## ğŸ¯ é€‚ç”¨åœºæ™¯

âœ… **é€‚åˆå¹¶è¡Œçš„åœºæ™¯**:
- æœç´¢æŸ¥è¯¢äº’ä¸ä¾èµ–
- ç½‘ç»œ I/O å¯†é›†å‹ä»»åŠ¡
- éœ€è¦å¿«é€Ÿè·å–å¤§é‡ä¿¡æ¯

âš ï¸ **ä¸é€‚åˆå¹¶è¡Œçš„åœºæ™¯**:
- åç»­æŸ¥è¯¢ä¾èµ–å‰ä¸€ä¸ªæŸ¥è¯¢çš„ç»“æœ
- æœ‰ä¸¥æ ¼çš„ API é€Ÿç‡é™åˆ¶
- éœ€è¦ç²¾ç¡®æ§åˆ¶è¯·æ±‚é¡ºåº

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ å¹¶å‘é™åˆ¶**:
   ```python
   semaphore = asyncio.Semaphore(5)  # æœ€å¤šåŒæ—¶5ä¸ªæŸ¥è¯¢
   async with semaphore:
       result = await self._execute_single_query(...)
   ```

2. **æ™ºèƒ½é™æµ**:
   - æ ¹æ®æœç´¢å¼•æ“çš„å“åº”é€Ÿåº¦åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°
   - æ£€æµ‹ 429 é”™è¯¯å¹¶è‡ªåŠ¨é™é€Ÿ

3. **ç»“æœæµå¼è¿”å›**:
   - ä¸ç­‰æ‰€æœ‰æŸ¥è¯¢å®Œæˆï¼Œå…ˆè¿”å›å·²å®Œæˆçš„ç»“æœ
   - ä½¿ç”¨ `asyncio.as_completed()` å®ç°

4. **ç¼“å­˜æœç´¢ç»“æœ**:
   - å¯¹ç›¸åŒæŸ¥è¯¢å¤ç”¨ç»“æœï¼Œé¿å…é‡å¤æœç´¢
   - ä½¿ç”¨ Redis æˆ–å†…å­˜ç¼“å­˜

---

## âœ… æµ‹è¯•éªŒè¯

è¿è¡Œæœç´¢å‘½ä»¤æµ‹è¯•æ€§èƒ½:
```bash
time python main_agent.py search "æµ‹è¯•æŸ¥è¯¢ä¸»é¢˜"
```

è§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼Œç¡®è®¤:
- âœ… å¤šä¸ªå­ä»»åŠ¡åŒæ—¶æ‰§è¡Œ
- âœ… æ¯ä¸ªå­ä»»åŠ¡çš„å¤šä¸ªæŸ¥è¯¢åŒæ—¶æ‰§è¡Œ
- âœ… æ€»è€—æ—¶æ˜¾è‘—å‡å°‘
- âœ… æ‰€æœ‰æŸ¥è¯¢ç»“æœæ­£ç¡®æ”¶é›†

---

**ä¼˜åŒ–å®Œæˆ** âœ…

ç³»ç»Ÿç°åœ¨æ”¯æŒå®Œå…¨å¹¶è¡Œæœç´¢ï¼Œé€Ÿåº¦æå‡ **5-6 å€**ï¼
